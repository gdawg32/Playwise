{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/animate.css@4.1.1/animate.min.css"/>
<style>
body {
    background: linear-gradient(135deg, #f8fafc 0%, #f0f4ff 100%);
}

main {
    padding-top: 90px;
}

.pizza-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

/* Header */
.pizza-header {
    text-align: center;
    margin-bottom: 3rem;
}

.pizza-header h1 {
    font-size: 3rem;
    font-weight: 900;
    background: linear-gradient(135deg, #7c3aed, #3b82f6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
}

.pizza-header p {
    font-size: 1.125rem;
    color: #64748b;
    font-weight: 500;
}

/* Selection Flow */
.selection-flow {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.selection-step {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 4px 24px rgba(124, 58, 237, 0.08);
    border: 2px solid rgba(124, 58, 237, 0.06);
    transition: all 0.3s ease;
    opacity: 0.5;
    pointer-events: none;
}

.selection-step.active {
    opacity: 1;
    pointer-events: all;
    border-color: rgba(124, 58, 237, 0.15);
}

.selection-step:hover.active {
    box-shadow: 0 8px 32px rgba(124, 58, 237, 0.12);
    border-color: rgba(124, 58, 237, 0.2);
}

.step-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.25rem;
}

.step-number {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7c3aed, #3b82f6);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 1.125rem;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
}

.selection-step:not(.active) .step-number {
    background: #cbd5e1;
    box-shadow: none;
}

.step-label {
    flex: 1;
}

.step-label h3 {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.25rem;
}

.step-label p {
    font-size: 0.875rem;
    color: #64748b;
}

.step-icon {
    color: #10b981;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.selection-step.completed .step-icon {
    opacity: 1;
}

/* Choices.js Custom Styling */
.choices {
    margin-bottom: 0;
}

.choices__inner {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 14px;
    min-height: 56px;
    padding: 1rem 1.25rem;
    font-size: 1.0625rem;
    transition: all 0.2s ease;
}

.choices__inner:hover {
    border-color: #cbd5e1;
    background: white;
}

.choices.is-focused .choices__inner {
    border-color: #7c3aed;
    box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
    background: white;
}

.choices__list--dropdown {
    border: 2px solid #7c3aed;
    border-radius: 14px;
    box-shadow: 0 12px 48px rgba(124, 58, 237, 0.2);
    margin-top: 8px;
    z-index: 10;
}

.choices__item--selectable {
    padding: 0.9375rem 1.25rem;
    transition: all 0.15s ease;
    font-size: 1rem;
}

.choices__item--selectable.is-highlighted {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.12), rgba(59, 130, 246, 0.1));
    color: #7c3aed;
}

.choices__input {
    background: white;
    font-size: 1rem;
}

/* Pizza Display Section */
.pizza-display {
    background: white;
    border-radius: 24px;
    padding: 3rem 2rem;
    box-shadow: 0 4px 24px rgba(124, 58, 237, 0.08);
    border: 2px solid rgba(124, 58, 237, 0.06);
    text-align: center;
    min-height: 500px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.pizza-display h2 {
    font-size: 1.75rem;
    font-weight: 800;
    color: #1e293b;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    justify-content: center;
}

.pizza-display h2::before,
.pizza-display h2::after {
    content: '';
    width: 4px;
    height: 28px;
    background: linear-gradient(135deg, #7c3aed, #3b82f6);
    border-radius: 2px;
}

/* Empty State */
.empty-state {
    max-width: 400px;
    margin: 0 auto;
}

.empty-state-icon {
    width: 100px;
    height: 100px;
    margin: 0 auto 2rem;
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(59, 130, 246, 0.08));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #7c3aed;
}

.empty-state h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.75rem;
}

.empty-state p {
    font-size: 1rem;
    color: #64748b;
    line-height: 1.6;
}

/* Pizza Image */
.pizza-image-container {
    position: relative;
    max-width: 100%;
    display: none;
}

.pizza-image-container.loaded {
    display: block;
    animation: fadeInUp 0.6s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.pizza-image-container img {
    max-width: 100%;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.player-badge {
    background: linear-gradient(135deg, #7c3aed, #3b82f6);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
}

/* Loading Spinner */
.loading-container {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.loading-container.active {
    display: flex;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(124, 58, 237, 0.2);
    border-radius: 50%;
    border-top-color: #7c3aed;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.125rem;
    color: #64748b;
    font-weight: 600;
}

/* Progress Indicator */
.progress-indicator {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
}

.progress-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #e2e8f0;
    transition: all 0.3s ease;
}

.progress-dot.active {
    background: linear-gradient(135deg, #7c3aed, #3b82f6);
    transform: scale(1.3);
    box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.2);
}

.progress-dot.completed {
    background: #10b981;
}

/* Info Cards */
.info-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.info-card {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(59, 130, 246, 0.05));
    border: 2px solid rgba(124, 58, 237, 0.1);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
}

.info-card-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 1rem;
    background: linear-gradient(135deg, #7c3aed, #3b82f6);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.info-card h4 {
    font-size: 0.9375rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
}

.info-card p {
    font-size: 0.8125rem;
    color: #64748b;
    line-height: 1.5;
}

@media (max-width: 768px) {
    .pizza-wrapper {
        padding: 1.5rem;
    }
    
    .pizza-header h1 {
        font-size: 2rem;
    }
    
    .selection-flow {
        gap: 1rem;
    }
    
    .selection-step {
        padding: 1.5rem;
    }
}
</style>
{% endblock %}

{% block content %}

<div class="pizza-wrapper">
    
    <!-- Header -->
    <div class="pizza-header animate__animated animate__fadeIn">
        <h1>Pizza Chart</h1>
        <p>Visualize player performance across multiple attributes</p>
    </div>

    <!-- Info Cards -->
    <div class="info-cards animate__animated animate__fadeInUp">
        <div class="info-card">
            <div class="info-card-icon">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <h4>Multi-Dimensional</h4>
            <p>View stats across multiple categories</p>
        </div>
        
        <div class="info-card">
            <div class="info-card-icon">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <h4>Easy Search</h4>
            <p>Find players quickly with search</p>
        </div>
        
        <div class="info-card">
            <div class="info-card-icon">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
            </div>
            <h4>Instant Visuals</h4>
            <p>Charts generate automatically</p>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="progress-dot" id="dot1"></div>
        <div class="progress-dot" id="dot2"></div>
        <div class="progress-dot" id="dot3"></div>
    </div>

    <!-- Selection Flow -->
    <div class="selection-flow">
        
        <!-- Step 1: Competition -->
        <div class="selection-step active" id="step1">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-label">
                    <h3>Choose Competition</h3>
                    <p>Select the league or tournament</p>
                </div>
                <svg class="step-icon" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <select id="competition">
                <option value="">Select a competition...</option>
                {% for c in competitions %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Step 2: Team -->
        <div class="selection-step" id="step2">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-label">
                    <h3>Choose Team</h3>
                    <p>Select the team from the competition</p>
                </div>
                <svg class="step-icon" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <select id="team">
                <option value="">Select a team...</option>
            </select>
        </div>

        <!-- Step 3: Player -->
        <div class="selection-step" id="step3">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-label">
                    <h3>Choose Player</h3>
                    <p>Select the player to visualize</p>
                </div>
                <svg class="step-icon" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <select id="player">
                <option value="">Select a player...</option>
            </select>
        </div>
    </div>

    <!-- Pizza Display -->
    <div class="pizza-display animate__animated animate__fadeInUp">
        <h2>Performance Pizza</h2>
        
        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                </svg>
            </div>
            <h3>Ready to visualize</h3>
            <p>Follow the steps above to select a player and view their performance pizza chart</p>
        </div>

        <!-- Loading State -->
        <div class="loading-container" id="loadingState">
            <div class="loading-spinner"></div>
            <p class="loading-text">Generating pizza chart...</p>
        </div>

        <!-- Pizza Image -->
        <div class="pizza-image-container" id="pizzaContainer">
            <div class="player-badge" id="playerBadge">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span id="playerName"></span>
            </div>
            <img id="pizzaImage" alt="Player pizza chart">
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
let choices = {};
let selectedData = {
    competition: null,
    team: null,
    player: null
};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Choices.js for all selects
    choices.competition = new Choices('#competition', {
        searchEnabled: true,
        searchPlaceholderValue: 'Search competitions...',
        itemSelectText: '',
        shouldSort: false
    });

    choices.team = new Choices('#team', {
        searchEnabled: true,
        searchPlaceholderValue: 'Search teams...',
        itemSelectText: '',
        shouldSort: false
    });

    choices.player = new Choices('#player', {
        searchEnabled: true,
        searchPlaceholderValue: 'Search players...',
        itemSelectText: '',
        shouldSort: false
    });

    // Event Listeners
    document.getElementById('competition').addEventListener('change', handleCompetitionChange);
    document.getElementById('team').addEventListener('change', handleTeamChange);
    document.getElementById('player').addEventListener('change', handlePlayerChange);
});

async function handleCompetitionChange(e) {
    const compId = e.target.value;
    selectedData.competition = compId;

    // Reset subsequent steps
    choices.team.clearStore();
    choices.player.clearStore();
    selectedData.team = null;
    selectedData.player = null;

    // Update UI
    updateStepStatus(1, compId ? 'completed' : 'active');
    updateStepStatus(2, compId ? 'active' : 'inactive');
    updateStepStatus(3, 'inactive');
    updateProgressDots();

    if (!compId) return;

    // Load teams
    choices.team.setChoices([{value: '', label: 'Loading teams...', disabled: true}], 'value', 'label', true);

    try {
        const res = await fetch(`/api/teams/?competition=${compId}`);
        const teams = await res.json();

        const teamOptions = [{value: '', label: 'Select a team...', selected: true}].concat(
            teams.map(t => ({value: t.id, label: t.name}))
        );

        choices.team.setChoices(teamOptions, 'value', 'label', true);
    } catch (error) {
        console.error('Error loading teams:', error);
        choices.team.setChoices([{value: '', label: 'Error loading teams', disabled: true}], 'value', 'label', true);
    }
}

async function handleTeamChange(e) {
    const teamId = e.target.value;
    selectedData.team = teamId;

    // Reset player step
    choices.player.clearStore();
    selectedData.player = null;

    // Update UI
    updateStepStatus(2, teamId ? 'completed' : 'active');
    updateStepStatus(3, teamId ? 'active' : 'inactive');
    updateProgressDots();
    hideChart();

    if (!teamId) return;

    // Load players
    choices.player.setChoices([{value: '', label: 'Loading players...', disabled: true}], 'value', 'label', true);

    try {
        const res = await fetch(`/api/players/?team=${teamId}`);
        const players = await res.json();

        const playerOptions = [{value: '', label: 'Select a player...', selected: true}].concat(
            players.map(p => ({value: p.player_id, label: p.name}))
        );

        choices.player.setChoices(playerOptions, 'value', 'label', true);
    } catch (error) {
        console.error('Error loading players:', error);
        choices.player.setChoices([{value: '', label: 'Error loading players', disabled: true}], 'value', 'label', true);
    }
}

function handlePlayerChange(e) {
    const playerId = e.target.value;
    const playerName = e.target.options[e.target.selectedIndex].text;
    selectedData.player = playerId;

    // Update UI
    updateStepStatus(3, playerId ? 'completed' : 'active');
    updateProgressDots();

    if (!playerId) {
        hideChart();
        return;
    }

    loadPizzaChart(playerId, playerName);
}

function loadPizzaChart(playerId, playerName) {
    const emptyState = document.getElementById('emptyState');
    const loadingState = document.getElementById('loadingState');
    const pizzaContainer = document.getElementById('pizzaContainer');
    const pizzaImage = document.getElementById('pizzaImage');
    const playerBadge = document.getElementById('playerBadge');
    const playerNameSpan = document.getElementById('playerName');

    // Show loading
    emptyState.style.display = 'none';
    loadingState.classList.add('active');
    pizzaContainer.classList.remove('loaded');

    // Set player name
    playerNameSpan.textContent = playerName;

    // Load image
    pizzaImage.onload = function() {
        loadingState.classList.remove('active');
        pizzaContainer.classList.add('loaded');
    };

    pizzaImage.onerror = function() {
        loadingState.classList.remove('active');
        emptyState.style.display = 'block';
        alert('Error loading pizza chart. Please try again.');
    };

    pizzaImage.src = `/api/pizza/?player_id=${playerId}`;
}

function hideChart() {
    const emptyState = document.getElementById('emptyState');
    const loadingState = document.getElementById('loadingState');
    const pizzaContainer = document.getElementById('pizzaContainer');

    emptyState.style.display = 'block';
    loadingState.classList.remove('active');
    pizzaContainer.classList.remove('loaded');
}

function updateStepStatus(stepNum, status) {
    const step = document.getElementById(`step${stepNum}`);
    step.classList.remove('active', 'completed');
    
    if (status === 'active') {
        step.classList.add('active');
    } else if (status === 'completed') {
        step.classList.add('completed', 'active');
    }
}

function updateProgressDots() {
    const dot1 = document.getElementById('dot1');
    const dot2 = document.getElementById('dot2');
    const dot3 = document.getElementById('dot3');

    // Reset all
    [dot1, dot2, dot3].forEach(dot => {
        dot.classList.remove('active', 'completed');
    });

    // Update based on selection
    if (selectedData.competition) {
        dot1.classList.add('completed');
        dot2.classList.add('active');
    } else {
        dot1.classList.add('active');
    }

    if (selectedData.team) {
        dot2.classList.add('completed');
        dot3.classList.add('active');
    }

    if (selectedData.player) {
        dot3.classList.add('completed');
    }
}
</script>
{% endblock %}
